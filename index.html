<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lector de Códigos por Carpeta</title>
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('fileInput');
      const outputText = document.getElementById('output');
      const downloadBtn = document.getElementById('downloadBtn');
      const reader = new BrowserMultiFormatReader();

      let resultados = [];

      fileInput.addEventListener('change', async (event) => {
        resultados = [];
        outputText.textContent = "Procesando imágenes...\n";

        const files = Array.from(event.target.files).filter(file =>
          /\.(jpe?g|png)$/i.test(file.name)
        );

        for (const file of files) {
          const imgURL = URL.createObjectURL(file);
          const img = new Image();
          img.src = imgURL;

          await new Promise((resolve) => {
            img.onload = async () => {
              try {
                const result = await reader.decodeFromImageElement(img);
                const linea = `${file.name}: ${result.text}`;
                resultados.push(linea);
                outputText.textContent += linea + '\n';
              } catch (err) {
                const linea = `${file.name}: (sin código leído)`;
                resultados.push(linea);
                outputText.textContent += linea + '\n';
              }
              resolve();
            };
          });

          URL.revokeObjectURL(imgURL);
        }

        downloadBtn.style.display = 'inline-block';
      });

      downloadBtn.addEventListener('click', () => {
        const blob = new Blob([resultados.join('\n')], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'codigos_leidos.txt';
        a.click();

        URL.revokeObjectURL(url);
      });
    });
  </script>
</head>
<body>
  <h2>🧾 Lector de códigos desde imágenes (sube una carpeta)</h2>
  <input type="file" id="fileInput" webkitdirectory multiple>
  <pre id="output" style="background:#f0f0f0; padding:1em; height:300px; overflow:auto;"></pre>
  <button id="downloadBtn" style="display:none;">📥 Descargar resultados</button>
</body>
</html>
